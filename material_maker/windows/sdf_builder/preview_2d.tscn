[gd_scene load_steps=7 format=2]

[ext_resource path="res://material_maker/panels/preview_2d/preview_2d_panel.tscn" type="PackedScene" id=1]

[sub_resource type="Shader" id=2]
resource_local_to_scene = true
code = "shader_type canvas_item;

void fragment() {
	COLOR = vec4(0.0, 0.0, 0.0, 1.0);
}
"

[sub_resource type="ShaderMaterial" id=3]
resource_local_to_scene = true
shader = SubResource( 2 )

[sub_resource type="GDScript" id=1]
script/source = "extends \"res://material_maker/panels/preview_2d/preview_2d_panel.gd\"

func _ready():
	pass # Replace with function body.
"

[sub_resource type="Shader" id=4]
resource_local_to_scene = true

[sub_resource type="ShaderMaterial" id=5]
resource_local_to_scene = true
shader = SubResource( 4 )

[node name="Preview2D" instance=ExtResource( 1 )]
material = SubResource( 3 )
script = SubResource( 1 )
shader = "uniform vec2 preview_2d_size = vec2(100.0);
uniform float preview_2d_scale = 1.2;
uniform vec2 preview_2d_center = vec2(0.5);
uniform int mode = 0;
uniform vec4 background_color_1 = vec4(0.0);
uniform vec4 background_color_2 = vec4(1.0);

void fragment() {
	vec2 ratio = preview_2d_size;
	vec2 uv = preview_2d_center+(UV-0.5)*preview_2d_scale*ratio/min(ratio.x, ratio.y);
	if (mode == 2 && (uv.x < 0.0 || uv.x > 1.0 || uv.y < 0.0 || uv.y > 1.0)) {
		COLOR = vec4(0.0);
	} else {
		if (mode == 1) {
			uv = fract(uv);
		}
		vec4 image = preview_2d_postprocessed(uv);
		float checkerboard = mod(floor(uv.x*32.0)+floor(uv.y*32.0), 2.0);
		vec3 image_with_background = mix(mix(background_color_1, background_color_2, checkerboard).rgb, image.rgb, image.a);
		COLOR = vec4(image_with_background, 1.0);
	}
}
"
shader_accumulate = "uniform sampler2D sum;
uniform bool clear = false;
uniform vec2 preview_2d_size = vec2(100.0);
uniform float preview_2d_scale = 1.2;
uniform vec2 preview_2d_center = vec2(0.5);

void fragment() {
	vec2 ratio = preview_2d_size;
	vec2 jitter_uv = UV+0.75*fract(sin(vec2(TIME, TIME*0.5)*43758.5453123))/preview_2d_size;
	vec2 uv = preview_2d_center+(jitter_uv-0.5)*preview_2d_scale*ratio/min(ratio.x, ratio.y);
	if (clear) {
		COLOR = preview_2d(uv);
	} else {
		COLOR = textureLod(sum, UV, 0.0)+preview_2d(uv);
	}
}
"
shader_divide = "shader_type canvas_item;

uniform sampler2D sum;
uniform int divide = 1;

void fragment() {
	COLOR = vec4(texture(sum, UV).rgb/float(divide), 1.0);
}"

[node name="ContextMenu" parent="." index="15"]
items = [ "Reset view", null, 0, false, false, 0, 0, null, "", false ]

[node name="View" parent="ContextMenu" index="0"]
items = [ "Extend", null, 2, true, false, 0, 0, null, "", false, "Repeat", null, 2, false, false, 1, 0, null, "", false, "Clamp", null, 2, false, false, 2, 0, null, "", false, "Temporal AA", null, 2, false, false, 3, 0, null, "", false ]

[node name="Iteration" parent="Accumulate" index="0"]
material = SubResource( 5 )
